# Shepherd

A lightweight fleet management server for [Nerves](https://nerves-project.org/) devices. Built with Phoenix, it provides secure device connectivity, real-time presence tracking, metrics ingestion, remote command execution, and over-the-air firmware updates.

Shepherd is a simpler alternative to NervesHub for teams that want essential fleet management without the complexity.

## Features

- **Certificate-based authentication** — Devices authenticate via ECDSA-signed messages verified against a Fleet CA. No passwords, no tokens.
- **Real-time presence** — Track which devices are online/offline using Phoenix Presence. No custom heartbeat needed.
- **Metrics ingestion** — Receive and process device metrics (memory, CPU, temperature, custom) via a telemetry-based pipeline with pluggable handlers.
- **Remote commands** — Send commands to connected devices: `reboot`, `identify`, `ping`, and `update`.
- **Firmware updates** — Push OTA firmware updates to individual devices with real-time progress reporting.
- **Device grouping** — Organize devices into groups for fleet-wide management.
- **Health endpoint** — `GET /api/health` returns server status and online device count.

## How It Works

Devices running [ShepherdClient](https://github.com/EvanMcEwen/shepherd_client) connect over WebSocket and authenticate by signing their serial number and a timestamp with their device private key. The server verifies the signature against the device's certificate, which must chain back to the Fleet CA.

```
Device                                Server
  |                                     |
  |-- WSS connect (serial, timestamp, --|
  |   signature, cert)                  |
  |                                     |-- Verify cert chain to Fleet CA
  |                                     |-- Verify signature
  |                                     |-- Register/update device
  |                                     |
  |<--------- channel joined -----------|
  |                                     |
  |-- status report ------------------->|
  |-- metrics ------------------------->|
  |<--------- commands -----------------|
```

## Requirements

- Elixir ~> 1.15
- PostgreSQL
- A generated Fleet CA (see below)

## Getting Started

```bash
# Clone and setup
git clone https://github.com/EvanMcEwen/shepherd.git
cd shepherd
mix setup

# Generate Fleet CA (one-time)
mix fleet.gen.ca

# Generate a device certificate
mix fleet.gen.device_cert --serial MY_DEVICE_001

# Start the server
mix phx.server
```

The server starts at `http://localhost:4000`.

### Verify it's running

```bash
curl http://localhost:4000/api/health
# {"status":"ok","online_devices":0}
```

## Configuration

### Development

Dev config loads the Fleet CA from a PEM file on disk (generated by `mix fleet.gen.ca`):

```elixir
# config/dev.exs
config :shepherd, :fleet_ca_pem, File.read!("priv/ca/fleet_ca.pem")
```

### Production

Production config reads from environment variables:

| Variable | Description |
|---|---|
| `DATABASE_URL` | PostgreSQL connection string |
| `SECRET_KEY_BASE` | Phoenix secret (generate with `mix phx.gen.secret`) |
| `FLEET_CA_PEM` | PEM-encoded Fleet CA certificate |
| `PHX_HOST` | Hostname for the server |
| `PORT` | HTTP port (default: 4000) |
| `DNS_CLUSTER_QUERY` | Optional DNS cluster query for distributed deployments |

```bash
# Example
export DATABASE_URL="ecto://user:pass@localhost/shepherd"
export SECRET_KEY_BASE=$(mix phx.gen.secret)
export FLEET_CA_PEM=$(cat priv/ca/fleet_ca.pem)
export PHX_HOST="fleet.example.com"
```

### Timestamp Tolerance

Device clocks may drift, especially before NTP sync. The default tolerance is 60 seconds:

```elixir
config :shepherd, :timestamp_tolerance, 120  # seconds
```

### Metrics Handlers

The metrics pipeline uses telemetry and supports pluggable handlers:

```elixir
config :shepherd, :metrics_handlers, [
  {:logger, Shepherd.Metrics.Handlers.Logger}
]
```

Implement the `Shepherd.Metrics.Handler` behaviour to build custom handlers (e.g., write to TimescaleDB, forward to Prometheus).

## Certificate Provisioning

Shepherd uses application-layer certificate verification (not mTLS), making it compatible with load balancers and platforms like Fly.io.

### 1. Generate a Fleet CA

```bash
mix fleet.gen.ca
# Creates priv/ca/fleet_ca.pem and priv/ca/fleet_ca_key.pem
```

Keep `fleet_ca_key.pem` secure. You'll need `fleet_ca.pem` for both the server config and to sign device certificates.

### 2. Generate Device Certificates

```bash
mix fleet.gen.device_cert --serial MY_DEVICE_001
# Creates priv/devices/MY_DEVICE_001/device_cert.der and device_key.pem
```

### 3. Deploy to Devices

Copy the device certificate and key to your Nerves device:

- **Production**: `/data/certs/device_cert.der` and `/data/certs/device_key.pem` (persists across firmware updates)
- **Development**: Bundle in `priv/certs/` of your Nerves project

Set the device serial:
```bash
fw_setenv nerves_serial_number MY_DEVICE_001
```

## Authentication Flow

The server performs multi-step verification on every connection:

1. Extract and validate serial number
2. Extract and validate timestamp (must be within tolerance)
3. Decode base64 signature and certificate
4. Parse certificate and verify it's not expired
5. Verify certificate is signed by Fleet CA
6. Match certificate CN to claimed serial
7. Verify ECDSA signature of `"serial:timestamp"`

Revoked devices (via the `revoked` flag) are disconnected and prevented from reconnecting.

## Database Schema

**devices**
- `serial` (unique), `nickname`, `status` (online/offline)
- `firmware_version`, `firmware_target`, `metadata` (JSON)
- `cert_fingerprint`, `cert_not_after`
- `revoked` (boolean), `last_seen_at`
- `group_id` (belongs to group)

**groups**
- `name`

## Testing

```bash
mix test
```

## Deployment

Shepherd is a standard Phoenix application. Deploy anywhere that supports Elixir releases:

```bash
MIX_ENV=prod mix release
PHX_SERVER=true _build/prod/rel/shepherd/bin/shepherd start
```

Fly.io, Render, and bare-metal servers all work. The only external dependency is PostgreSQL.
